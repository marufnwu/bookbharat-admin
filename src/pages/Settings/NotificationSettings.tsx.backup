import React, { useState, useEffect } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import notificationSettingsApi from '../../api/notificationSettings';
import { showToast } from '../../utils/toast';
import {
  Bell,
  Mail,
  MessageSquare,
  Phone,
  Check,
  X,
  RefreshCw,
  Send,
  Settings,
  AlertCircle,
  CheckCircle,
  Loader2
} from 'lucide-react';

interface NotificationSetting {
  id?: number;
  event_type: string;
  channels: string[];
  enabled: boolean;
  sms_gateway_url?: string;
  sms_api_key?: string;
  sms_sender_id?: string;
  sms_request_format?: string;
  whatsapp_api_url?: string;
  whatsapp_access_token?: string;
  whatsapp_phone_number_id?: string;
  whatsapp_business_account_id?: string;
  whatsapp_templates?: any[];
  email_from?: string;
  email_from_name?: string;
}

const NotificationSettings: React.FC = () => {
  const queryClient = useQueryClient();
  const [activeTab, setActiveTab] = useState<'events' | 'sms' | 'whatsapp' | 'email'>('events');
  const [editingEvent, setEditingEvent] = useState<string | null>(null);
  const [testChannel, setTestChannel] = useState<string>('');
  const [testRecipient, setTestRecipient] = useState<string>('');

  // Email validation helper
  const isValidEmail = (email: string) => {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  };

  // Email configuration validation
  const isEmailConfigValid = () => {
    return emailConfig.host &&
           emailConfig.username &&
           emailConfig.password &&
           emailConfig.from_address &&
           isValidEmail(emailConfig.from_address) &&
           emailConfig.from_name;
  };

  // Initialize activeTab from URL hash on component mount
  useEffect(() => {
    const hash = window.location.hash.replace('#', '');
    if (['events', 'sms', 'whatsapp', 'email'].includes(hash)) {
      setActiveTab(hash as any);
    }

    // Listen for hash changes (browser back/forward buttons)
    const handleHashChange = () => {
      const newHash = window.location.hash.replace('#', '');
      if (['events', 'sms', 'whatsapp', 'email'].includes(newHash)) {
        setActiveTab(newHash as any);
      }
    };

    window.addEventListener('hashchange', handleHashChange);

    // Cleanup event listener on component unmount
    return () => {
      window.removeEventListener('hashchange', handleHashChange);
    };
  }, []);

  // Update URL hash when activeTab changes
  useEffect(() => {
    if (activeTab && window.location.hash !== `#${activeTab}`) {
      window.history.replaceState(null, '', `#${activeTab}`);
    }
  }, [activeTab]);

  // SMS Configuration State
  const [smsConfig, setSmsConfig] = useState({
    gateway_url: '',
    api_key: '',
    sender_id: 'BKBHRT',
    request_format: 'json' as 'json' | 'form',
  });

  // WhatsApp Configuration State
  const [whatsappConfig, setWhatsappConfig] = useState({
    api_url: 'https://graph.facebook.com/v18.0',
    access_token: '',
    phone_number_id: '',
    business_account_id: '',
  });

  // Email Configuration State
  const [emailConfig, setEmailConfig] = useState({
    host: '',
    port: 587,
    encryption: 'tls' as 'tls' | 'ssl',
    username: '',
    password: '',
    from_address: '',
    from_name: '',
  });

  // Fetch notification settings
  const { data: settingsData, isLoading } = useQuery({
    queryKey: ['notification-settings'],
    queryFn: () => notificationSettingsApi.getSettings(),
  });

  // Fetch email configuration
  const { data: emailConfigData } = useQuery({
    queryKey: ['email-config'],
    queryFn: () => notificationSettingsApi.getEmailConfig(),
  });

  // Update email config state when data loads
  React.useEffect(() => {
    if (emailConfigData?.success && emailConfigData?.config) {
      setEmailConfig({
        host: emailConfigData.config.host || '',
        port: emailConfigData.config.port || 587,
        encryption: emailConfigData.config.encryption || 'tls',
        username: '',
        password: '',
        from_address: emailConfigData.config.from_address || '',
        from_name: emailConfigData.config.from_name || '',
      });
    }
  }, [emailConfigData]);

  const settings: Record<string, NotificationSetting> = settingsData?.settings || {};
  const eventTypes: Record<string, string> = settingsData?.event_types || {};
  const availableChannels: string[] = settingsData?.available_channels || [];

  // Update SMS config state when data loads
  React.useEffect(() => {
    if (settings && Object.keys(settings).length > 0) {
      // Get the first event type that has SMS configuration
      const firstEventType = Object.keys(settings)[0];
      const firstSetting = settings[firstEventType];

      if (firstSetting && firstSetting.sms_gateway_url) {
        setSmsConfig({
          gateway_url: firstSetting.sms_gateway_url || '',
          api_key: firstSetting.sms_api_key || '',
          sender_id: firstSetting.sms_sender_id || 'BKBHRT',
          request_format: (firstSetting.sms_request_format as 'json' | 'form') || 'json',
        });
      }
    }
  }, [settings]);

  // Update WhatsApp config state when data loads
  React.useEffect(() => {
    if (settings && Object.keys(settings).length > 0) {
      // Get the first event type that has WhatsApp configuration
      const firstEventType = Object.keys(settings)[0];
      const firstSetting = settings[firstEventType];

      if (firstSetting && firstSetting.whatsapp_api_url) {
        setWhatsappConfig({
          api_url: firstSetting.whatsapp_api_url || 'https://graph.facebook.com/v18.0',
          access_token: firstSetting.whatsapp_access_token || '',
          phone_number_id: firstSetting.whatsapp_phone_number_id || '',
          business_account_id: firstSetting.whatsapp_business_account_id || '',
        });
      }
    }
  }, [settings]);

  // Update settings mutation
  const updateMutation = useMutation({
    mutationFn: (data: NotificationSetting) => notificationSettingsApi.updateSettings(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['notification-settings'] });
      showToast.success('Settings updated successfully');
      setEditingEvent(null);
    },
    onError: (error: any) => {
      showToast.error('Failed to update settings: ' + (error.response?.data?.message || error.message));
    },
  });

  // Test SMS mutation
  const testSMSMutation = useMutation({
    mutationFn: (data: any) => {
      console.log('ðŸ“¡ Calling SMS test API with data:', data);
      return notificationSettingsApi.testSMSConnection(data);
    },
    onSuccess: (response) => {
      console.log('ðŸ“¨ SMS test API response:', response);

      if (response.success) {
        showToast.success(`SMS test successful! Message sent to ${response.test_number}.`);

        // Log success details
        if (response.response?.message_id) {
          console.log('âœ… SMS delivered with Message ID:', response.response.message_id);
        }
        if (response.status_code) {
          console.log('ðŸ“Š API Status Code:', response.status_code);
        }
      } else {
        showToast.error('SMS test failed: ' + (response.message || 'Unknown error'));
        console.error('âŒ SMS test failed response:', response);
      }
    },
    onError: (error: any) => {
      console.error('ðŸ’¥ SMS test API error:', error);

      let errorMessage = 'SMS test failed';

      if (error.response?.data?.message) {
        errorMessage = error.response.data.message;
      } else if (error.response?.data?.error) {
        errorMessage = error.response.data.error;
      } else if (error.message) {
        errorMessage = error.message;
      }

      // Add specific error guidance
      if (error.response?.status === 422) {
        errorMessage += ' Please check your API credentials and try again.';
      } else if (error.response?.status === 500) {
        errorMessage += ' Server error. Please try again in a few minutes.';
      } else if (error.code === 'NETWORK_ERROR') {
        errorMessage += ' Network error. Please check your internet connection.';
      }

      showToast.error(errorMessage);
    },
  });

  // Test WhatsApp mutation
  const testWhatsAppMutation = useMutation({
    mutationFn: (data: any) => notificationSettingsApi.testWhatsAppConnection(data),
    onSuccess: (response) => {
      if (response.success) {
        showToast.success('WhatsApp test successful! Message sent.');
      } else {
        showToast.error('WhatsApp test failed: ' + response.message);
      }
    },
    onError: (error: any) => {
      showToast.error('WhatsApp test failed: ' + (error.response?.data?.message || error.message));
    },
  });

  // Sync WhatsApp templates mutation
  const syncTemplatesMutation = useMutation({
    mutationFn: (data: any) => notificationSettingsApi.syncWhatsAppTemplates(data),
    onSuccess: (response) => {
      if (response.success) {
        showToast.success(`Synced ${response.templates.length} WhatsApp templates`);
        queryClient.invalidateQueries({ queryKey: ['notification-settings'] });
      } else {
        showToast.error('Template sync failed: ' + response.message);
      }
    },
    onError: (error: any) => {
      showToast.error('Template sync failed: ' + (error.response?.data?.message || error.message));
    },
  });

  // Test notification mutation
  const testNotificationMutation = useMutation({
    mutationFn: (data: any) => notificationSettingsApi.sendTestNotification(data),
    onSuccess: (response) => {
      if (response.success) {
        showToast.success(`Test ${testChannel} notification sent successfully!`);
        setTestRecipient('');
      } else {
        showToast.error('Test failed: ' + response.message);
      }
    },
    onError: (error: any) => {
      showToast.error('Test failed: ' + (error.response?.data?.message || error.message));
    },
  });

  // Update email config mutation
  const updateEmailMutation = useMutation({
    mutationFn: (data: any) => notificationSettingsApi.updateEmailConfig(data),
    onSuccess: (response) => {
      if (response.success) {
        showToast.success('Email configuration updated successfully!');
        queryClient.invalidateQueries({ queryKey: ['email-config'] });
      } else {
        showToast.error('Update failed: ' + response.message);
      }
    },
    onError: (error: any) => {
      showToast.error('Update failed: ' + (error.response?.data?.message || error.message));
    },
  });

  const handleChannelToggle = (eventType: string, channel: string) => {
    const setting = settings[eventType] || {
      event_type: eventType,
      channels: [],
      enabled: true,
    };

    const channels = setting.channels || [];
    const newChannels = channels.includes(channel)
      ? channels.filter((c: string) => c !== channel)
      : [...channels, channel];

    updateMutation.mutate({
      ...setting,
      channels: newChannels,
    });
  };

  const handleEventToggle = (eventType: string) => {
    const setting = settings[eventType] || {
      event_type: eventType,
      channels: ['email'],
      enabled: true,
    };

    updateMutation.mutate({
      ...setting,
      enabled: !setting.enabled,
    });
  };

  const handleSMSTest = () => {
    // Validation check
    if (!smsConfig.gateway_url) {
      showToast.error('Please configure Gateway API Endpoint');
      return;
    }
    if (!smsConfig.api_key) {
      showToast.error('Please configure API Key');
      return;
    }
    if (!testRecipient || testRecipient.length !== 10) {
      showToast.error('Please enter a valid 10-digit test phone number');
      return;
    }

    // Show loading confirmation
    console.log('ðŸš€ Sending SMS test with config:', {
      gateway_url: smsConfig.gateway_url,
      has_api_key: !!smsConfig.api_key,
      test_number: testRecipient,
      request_format: smsConfig.request_format
    });

    testSMSMutation.mutate({
      gateway_url: smsConfig.gateway_url,
      api_key: smsConfig.api_key,
      test_number: testRecipient,
      request_format: smsConfig.request_format,
      sender_id: smsConfig.sender_id || 'BKBHRT'
    });
  };

  const handleWhatsAppTest = () => {
    if (!whatsappConfig.api_url || !whatsappConfig.access_token || !whatsappConfig.phone_number_id || !testRecipient) {
      showToast.error('Please fill in all WhatsApp configuration fields and test number');
      return;
    }

    testWhatsAppMutation.mutate({
      ...whatsappConfig,
      test_number: testRecipient,
    });
  };

  const handleSyncTemplates = () => {
    if (!whatsappConfig.access_token || !whatsappConfig.business_account_id) {
      showToast.error('Please provide WhatsApp access token and business account ID');
      return;
    }

    syncTemplatesMutation.mutate(whatsappConfig);
  };

  const handleTestNotification = () => {
    if (!testChannel || !testRecipient) {
      showToast.error('Please select a channel and enter recipient');
      return;
    }

    testNotificationMutation.mutate({
      channel: testChannel,
      recipient: testRecipient,
      event_type: 'test_notification',
    });
  };

  const saveSMSConfig = () => {
    // Save SMS config to all events (global config)
    const firstEventType = Object.keys(eventTypes)[0];
    if (!firstEventType) return;

    const setting = settings[firstEventType] || {
      event_type: firstEventType,
      channels: ['email'],
      enabled: true,
    };

    updateMutation.mutate({
      ...setting,
      sms_gateway_url: smsConfig.gateway_url,
      sms_api_key: smsConfig.api_key,
      sms_sender_id: smsConfig.sender_id,
      sms_request_format: smsConfig.request_format,
    });
  };

  const saveWhatsAppConfig = () => {
    // Save WhatsApp config to all events (global config)
    const firstEventType = Object.keys(eventTypes)[0];
    if (!firstEventType) return;

    const setting = settings[firstEventType] || {
      event_type: firstEventType,
      channels: ['email'],
      enabled: true,
    };

    updateMutation.mutate({
      ...setting,
      whatsapp_api_url: whatsappConfig.api_url,
      whatsapp_access_token: whatsappConfig.access_token,
      whatsapp_phone_number_id: whatsappConfig.phone_number_id,
      whatsapp_business_account_id: whatsappConfig.business_account_id,
    });
  };

  const saveEmailConfig = () => {
    if (!emailConfig.host || !emailConfig.username || !emailConfig.password) {
      showToast.error('Please fill in all required email configuration fields');
      return;
    }

    updateEmailMutation.mutate(emailConfig);
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-96">
        <Loader2 className="h-8 w-8 animate-spin text-gray-400" />
      </div>
    );
  }

  return (
    <div className="p-6">
      <div className="mb-6">
        <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
          <Bell className="h-6 w-6" />
          Notification Settings
        </h1>
        <p className="text-gray-600 mt-1">
          Configure email, SMS, and WhatsApp notifications for different events
        </p>
      </div>

      {/* Tabs */}
      <div className="border-b border-gray-200 mb-6">
        <nav className="flex gap-4">
          {[
            { id: 'events', label: 'Event Channels', icon: Settings },
            { id: 'sms', label: 'SMS Gateway', icon: Phone },
            { id: 'whatsapp', label: 'WhatsApp API', icon: MessageSquare },
            { id: 'email', label: 'Email Config', icon: Mail },
          ].map((tab) => {
            const Icon = tab.icon;
            return (
              <a
                key={tab.id}
                href={`#${tab.id}`}
                onClick={(e) => {
                  e.preventDefault();
                  setActiveTab(tab.id as any);
                }}
                className={`flex items-center gap-2 px-4 py-3 border-b-2 font-medium transition-colors ${
                  activeTab === tab.id
                    ? 'border-blue-500 text-blue-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700'
                }`}
              >
                <Icon className="h-4 w-4" />
                {tab.label}
              </a>
            );
          })}
        </nav>
      </div>

      {/* Event Channels Tab */}
      {activeTab === 'events' && (
        <div className="space-y-6">
          <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
            <div className="flex gap-3">
              <AlertCircle className="h-5 w-5 text-purple-600 flex-shrink-0 mt-0.5" />
              <div className="text-sm text-purple-800">
                <p className="font-semibold mb-1">Event Channel Configuration:</p>
                <ul className="list-disc list-inside space-y-1">
                  <li>Enable/disable notification channels for different events</li>
                  <li>Configure SMS, Email, and WhatsApp delivery methods</li>
                  <li>Test each channel before enabling in production</li>
                  <li>Channel availability depends on service configuration</li>
                </ul>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200">
              <div className="flex items-center justify-between">
                <h3 className="text-lg font-semibold text-gray-900">Notification Events</h3>
                <div className="flex items-center gap-4 text-sm">
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 bg-blue-600 rounded-full"></div>
                    <span className="text-gray-600">Email</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 bg-green-600 rounded-full"></div>
                    <span className="text-gray-600">SMS</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 bg-emerald-600 rounded-full"></div>
                    <span className="text-gray-600">WhatsApp</span>
                  </div>
                </div>
              </div>
            </div>

            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Event Type
                    </th>
                    <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Status
                    </th>
                    <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                      <Mail className="h-4 w-4 inline" /> Email
                    </th>
                    <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                      <Phone className="h-4 w-4 inline" /> SMS
                    </th>
                    <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                      <MessageSquare className="h-4 w-4 inline" /> WhatsApp
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {Object.entries(eventTypes).map(([key, label]) => {
                    const setting = settings[key] || { event_type: key, channels: ['email'], enabled: true };
                    const channels = setting.channels || [];

                    return (
                      <tr key={key} className={`${!setting.enabled ? 'opacity-50' : ''} hover:bg-gray-50 transition-colors`}>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="flex items-center gap-3">
                            <div className="flex flex-col">
                              <div className="text-sm font-medium text-gray-900">{label}</div>
                              <div className="text-xs text-gray-500 font-mono">{key}</div>
                            </div>
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-center">
                          <button
                            onClick={() => handleEventToggle(key)}
                            className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${
                              setting.enabled ? 'bg-blue-600' : 'bg-gray-200'
                            }`}
                            title={setting.enabled ? 'Disable event' : 'Enable event'}
                          >
                            <span
                              className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform shadow-sm ${
                                setting.enabled ? 'translate-x-6' : 'translate-x-1'
                              }`}
                            />
                          </button>
                          <div className="text-xs mt-1">
                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                              setting.enabled
                                ? 'bg-green-100 text-green-800'
                                : 'bg-gray-100 text-gray-800'
                            }`}>
                              {setting.enabled ? 'Active' : 'Inactive'}
                            </span>
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-center">
                          <button
                            onClick={() => handleChannelToggle(key, 'email')}
                            disabled={!setting.enabled}
                            className={`p-2 rounded-lg transition-all hover:scale-105 ${
                              channels.includes('email')
                                ? 'bg-blue-100 text-blue-600 hover:bg-blue-200'
                                : 'bg-gray-100 text-gray-400 hover:bg-gray-200'
                            } disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100`}
                            title={channels.includes('email') ? 'Disable email notifications' : 'Enable email notifications'}
                          >
                            {channels.includes('email') ? (
                              <CheckCircle className="h-5 w-5" />
                            ) : (
                              <X className="h-5 w-5" />
                            )}
                          </button>
                          <div className="text-xs mt-1">
                            {channels.includes('email') && (
                              <span className="text-green-600 font-medium">Active</span>
                            )}
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-center">
                          <button
                            onClick={() => handleChannelToggle(key, 'sms')}
                            disabled={!setting.enabled}
                            className={`p-2 rounded-lg transition-all hover:scale-105 ${
                              channels.includes('sms')
                                ? 'bg-green-100 text-green-600 hover:bg-green-200'
                                : 'bg-gray-100 text-gray-400 hover:bg-gray-200'
                            } disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100`}
                            title={channels.includes('sms') ? 'Disable SMS notifications' : 'Enable SMS notifications'}
                          >
                            {channels.includes('sms') ? (
                              <CheckCircle className="h-5 w-5" />
                            ) : (
                              <X className="h-5 w-5" />
                            )}
                          </button>
                          <div className="text-xs mt-1">
                            {channels.includes('sms') && (
                              <span className="text-green-600 font-medium">Active</span>
                            )}
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-center">
                          <button
                            onClick={() => handleChannelToggle(key, 'whatsapp')}
                            disabled={!setting.enabled}
                            className={`p-2 rounded-lg transition-all hover:scale-105 ${
                              channels.includes('whatsapp')
                                ? 'bg-emerald-100 text-emerald-600 hover:bg-emerald-200'
                                : 'bg-gray-100 text-gray-400 hover:bg-gray-200'
                          } disabled:opacity-50 disabled:cursor-not-allowed`}
                            title={channels.includes('whatsapp') ? 'Disable WhatsApp notifications' : 'Enable WhatsApp notifications'}
                        >
                          {channels.includes('whatsapp') ? (
                            <CheckCircle className="h-5 w-5" />
                          ) : (
                            <X className="h-5 w-5" />
                          )}
                        </button>
                        <div className="text-xs mt-1">
                          {channels.includes('whatsapp') && (
                            <span className="text-green-600 font-medium">Active</span>
                          )}
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          {/* Summary Section */}
          <div className="bg-white rounded-lg shadow p-6">
            <h3 className="text-lg font-semibold mb-4">Configuration Summary</h3>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="text-center p-4 bg-blue-50 rounded-lg">
                <div className="text-2xl font-bold text-blue-600">
                  {Object.values(settings).filter(s => s?.enabled).length}
                </div>
                <div className="text-sm text-blue-800 mt-1">Active Events</div>
                <div className="text-xs text-blue-600 mt-2">
                  out of {Object.keys(eventTypes).length} total events
                </div>
              </div>

              <div className="text-center p-4 bg-green-50 rounded-lg">
                <div className="text-2xl font-bold text-green-600">
                  {Object.values(settings).filter(s => s?.channels?.includes('sms')).length}
                </div>
                <div className="text-sm text-green-800 mt-1">SMS Events</div>
                <div className="text-xs text-green-600 mt-2">
                  {Object.values(settings).some(s => s?.channels?.includes('sms'))
                    ? 'SMS is configured'
                    : 'Configure SMS gateway first'
                  }
                </div>
              </div>

              <div className="text-center p-4 bg-emerald-50 rounded-lg">
                <div className="text-2xl font-bold text-emerald-600">
                  {Object.values(settings).filter(s => s?.channels?.includes('whatsapp')).length}
                </div>
                <div className="text-sm text-emerald-800 mt-1">WhatsApp Events</div>
                <div className="text-xs text-emerald-600 mt-2">
                  {Object.values(settings).some(s => s?.channels?.includes('whatsapp'))
                    ? 'WhatsApp is configured'
                    : 'Configure WhatsApp API first'
                  }
                </div>
              </div>
            </div>

            <div className="mt-6 p-4 bg-gray-50 rounded-lg">
              <h4 className="text-sm font-semibold text-gray-700 mb-2">Quick Actions</h4>
              <div className="flex flex-wrap gap-3">
                <button
                  onClick={() => setActiveTab('sms')}
                  className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm flex items-center gap-2"
                >
                  <Phone className="h-4 w-4" />
                  Configure SMS
                </button>
                <button
                  onClick={() => setActiveTab('whatsapp')}
                  className="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 text-sm flex items-center gap-2"
                >
                  <MessageSquare className="h-4 w-4" />
                  Configure WhatsApp
                </button>
                <button
                  onClick={() => setActiveTab('email')}
                  className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm flex items-center gap-2"
                >
                  <Mail className="h-4 w-4" />
                  Configure Email
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* SMS Gateway Tab */}
      {activeTab === 'sms' && (
        <div className="space-y-6">
          <div className="bg-white rounded-lg shadow p-6">
            <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
              <Phone className="h-5 w-5" />
              SMS Gateway Configuration
            </h2>

            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
              <div className="flex gap-3">
                <AlertCircle className="h-5 w-5 text-blue-600 flex-shrink-0 mt-0.5" />
                <div className="text-sm text-blue-800">
                  <p className="font-semibold mb-1">SMS Gateway Setup:</p>
                  <ul className="list-disc list-inside space-y-1">
                    <li>Configure your SMS provider API credentials</li>
                    <li>Test connection before saving configuration</li>
                    <li>Supported providers: MSG91, Twilio, TextLocal, etc.</li>
                  </ul>
                </div>
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Configuration Fields */}
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Gateway API Endpoint *
                  </label>
                  <input
                    type="url"
                    value={smsConfig.gateway_url}
                    onChange={(e) => setSmsConfig({ ...smsConfig, gateway_url: e.target.value })}
                    placeholder="https://api.msg91.com/api/v5/send"
                    className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                      smsConfig.gateway_url ? 'border-gray-300' : 'border-red-300'
                    }`}
                  />
                  {smsConfig.gateway_url && (
                    <p className="text-xs text-green-600 mt-1">âœ“ API endpoint configured</p>
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    API Key *
                  </label>
                  <div className="relative">
                    <input
                      type="password"
                      value={smsConfig.api_key}
                      onChange={(e) => setSmsConfig({ ...smsConfig, api_key: e.target.value })}
                      placeholder="Enter your SMS gateway API key"
                      className={`w-full px-4 py-2 pr-10 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                        smsConfig.api_key ? 'border-gray-300' : 'border-red-300'
                      }`}
                    />
                    {smsConfig.api_key && (
                      <CheckCircle className="absolute right-3 top-2.5 h-5 w-5 text-green-500" />
                    )}
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Sender ID
                  </label>
                  <input
                    type="text"
                    value={smsConfig.sender_id}
                    onChange={(e) => setSmsConfig({ ...smsConfig, sender_id: e.target.value })}
                    placeholder="BKBHRT"
                    maxLength={11}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                  <p className="text-xs text-gray-500 mt-1">Maximum 11 characters (e.g., BKBHRT)</p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Request Format
                  </label>
                  <select
                    value={smsConfig.request_format}
                    onChange={(e) => setSmsConfig({ ...smsConfig, request_format: e.target.value as any })}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="json">JSON Format</option>
                    <option value="form">Form-Encoded</option>
                  </select>
                </div>
              </div>

              {/* Test Configuration */}
              <div className="space-y-4">
                <div className="bg-gray-50 rounded-lg p-4">
                  <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                    <Send className="h-5 w-5 text-green-600" />
                    Test SMS Configuration
                  </h3>

                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Test Phone Number *
                      </label>
                      <div className="flex gap-2">
                        <div className="flex items-center px-3 border border-gray-300 rounded-l-lg bg-gray-50">
                          <span className="text-gray-600">+91</span>
                        </div>
                        <input
                          type="tel"
                          value={testRecipient}
                          onChange={(e) => {
                            const value = e.target.value.replace(/\D/g, '').slice(0, 10);
                            setTestRecipient(value);
                          }}
                          placeholder="9876543210"
                          maxLength={10}
                          className={`flex-1 px-4 py-2 border rounded-r-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                            testRecipient && testRecipient.length === 10
                              ? 'border-green-300'
                              : testRecipient
                                ? 'border-yellow-300'
                                : 'border-gray-300'
                          }`}
                        />
                      </div>
                      {testRecipient && (
                        <p className={`text-xs mt-1 ${
                          testRecipient.length === 10
                            ? 'text-green-600'
                            : 'text-yellow-600'
                        }`}>
                          {testRecipient.length === 10
                            ? 'âœ“ Valid 10-digit number'
                            : `âš  Enter ${10 - testRecipient.length} more digit(s)`
                          }
                        </p>
                      )}
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Test Message
                      </label>
                      <textarea
                        value="This is a test SMS from BookBharat notification system."
                        readOnly
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600"
                        rows={3}
                      />
                    </div>

                    <button
                      onClick={handleSMSTest}
                      disabled={testSMSMutation.isPending || !smsConfig.gateway_url || !smsConfig.api_key || testRecipient.length !== 10}
                      className="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 font-medium"
                    >
                      {testSMSMutation.isPending ? (
                        <>
                          <Loader2 className="h-4 w-4 animate-spin" />
                          Sending Test SMS...
                        </>
                      ) : (
                        <>
                          <Send className="h-4 w-4" />
                          Send Test SMS
                        </>
                      )}
                    </button>

                    {!smsConfig.gateway_url && (
                      <p className="text-xs text-red-600">âš  Please configure API endpoint first</p>
                    )}
                    {!smsConfig.api_key && (
                      <p className="text-xs text-red-600">âš  Please configure API key first</p>
                    )}
                    {testRecipient && testRecipient.length !== 10 && (
                      <p className="text-xs text-yellow-600">âš  Please enter a valid 10-digit phone number</p>
                    )}
                  </div>
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={saveSMSConfig}
                    disabled={updateMutation.isPending || !smsConfig.gateway_url || !smsConfig.api_key}
                    className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  >
                    {updateMutation.isPending ? (
                      <>
                        <Loader2 className="h-4 w-4 animate-spin" />
                        Saving...
                      </>
                    ) : (
                      <>
                        <Check className="h-4 w-4" />
                        Save Configuration
                      </>
                    )}
                  </button>
                </div>
              </div>
            </div>
          </div>

          {/* Popular SMS Providers */}
          <div className="bg-white rounded-lg shadow p-6">
            <h3 className="text-lg font-semibold mb-4">Popular SMS Providers</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
              <div className="border rounded-lg p-4 hover:shadow-md transition-shadow">
                <div className="font-semibold text-gray-900 mb-2">MSG91</div>
                <div className="text-gray-600 space-y-1">
                  <p>Endpoint: api.msg91.com</p>
                  <p>Format: JSON</p>
                  <p className="text-xs text-blue-600">Most popular in India</p>
                </div>
              </div>

              <div className="border rounded-lg p-4 hover:shadow-md transition-shadow">
                <div className="font-semibold text-gray-900 mb-2">Twilio</div>
                <div className="text-gray-600 space-y-1">
                  <p>Endpoint: api.twilio.com</p>
                  <p>Format: Form-Encoded</p>
                  <p className="text-xs text-blue-600">Global provider</p>
                </div>
              </div>

              <div className="border rounded-lg p-4 hover:shadow-md transition-shadow">
                <div className="font-semibold text-gray-900 mb-2">TextLocal</div>
                <div className="text-gray-600 space-y-1">
                  <p>Endpoint: api.textlocal.in</p>
                  <p>Format: Form-Encoded</p>
                  <p className="text-xs text-blue-600">India focused</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* WhatsApp Business API Tab */}
      {activeTab === 'whatsapp' && (
        <div className="space-y-6">
          <div className="bg-white rounded-lg shadow p-6">
            <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
              <MessageSquare className="h-5 w-5 text-green-600" />
              WhatsApp Business API Configuration
            </h2>

            <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
              <div className="flex gap-3">
                <AlertCircle className="h-5 w-5 text-green-600 flex-shrink-0 mt-0.5" />
                <div className="text-sm text-green-800">
                  <p className="font-semibold mb-1">WhatsApp Business Setup:</p>
                  <ul className="list-disc list-inside space-y-1">
                    <li>Get verified WhatsApp Business Account from Meta</li>
                    <li>Configure phone number and business account ID</li>
                    <li>Templates must be pre-approved before sending messages</li>
                    <li>Test connection before saving configuration</li>
                  </ul>
                </div>
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Configuration Fields */}
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    WhatsApp API URL *
                  </label>
                  <input
                    type="url"
                    value={whatsappConfig.api_url}
                    onChange={(e) => setWhatsappConfig({ ...whatsappConfig, api_url: e.target.value })}
                    placeholder="https://graph.facebook.com/v18.0"
                    className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent ${
                      whatsappConfig.api_url ? 'border-gray-300' : 'border-red-300'
                    }`}
                  />
                  {whatsappConfig.api_url && (
                    <p className="text-xs text-green-600 mt-1">âœ“ API endpoint configured</p>
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Access Token *
                  </label>
                  <div className="relative">
                    <input
                      type="password"
                      value={whatsappConfig.access_token}
                      onChange={(e) => setWhatsappConfig({ ...whatsappConfig, access_token: e.target.value })}
                      placeholder="Enter WhatsApp Business API access token"
                      className={`w-full px-4 py-2 pr-10 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent ${
                        whatsappConfig.access_token ? 'border-gray-300' : 'border-red-300'
                      }`}
                    />
                    {whatsappConfig.access_token && (
                      <CheckCircle className="absolute right-3 top-2.5 h-5 w-5 text-green-500" />
                    )}
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Phone Number ID *
                  </label>
                  <input
                    type="text"
                    value={whatsappConfig.phone_number_id}
                    onChange={(e) => setWhatsappConfig({ ...whatsappConfig, phone_number_id: e.target.value })}
                    placeholder="1234567890123456"
                    className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent ${
                      whatsappConfig.phone_number_id ? 'border-gray-300' : 'border-red-300'
                    }`}
                  />
                  {whatsappConfig.phone_number_id && (
                    <p className="text-xs text-green-600 mt-1">âœ“ Phone ID configured</p>
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Business Account ID *
                  </label>
                  <input
                    type="text"
                    value={whatsappConfig.business_account_id}
                    onChange={(e) => setWhatsappConfig({ ...whatsappConfig, business_account_id: e.target.value })}
                    placeholder="1234567890123456"
                    className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent ${
                      whatsappConfig.business_account_id ? 'border-gray-300' : 'border-red-300'
                    }`}
                  />
                  {whatsappConfig.business_account_id && (
                    <p className="text-xs text-green-600 mt-1">âœ“ Business account ID configured</p>
                  )}
                </div>
              </div>

              {/* Test Configuration */}
              <div className="space-y-4">
                <div className="bg-gray-50 rounded-lg p-4">
                  <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                    <Send className="h-5 w-5 text-green-600" />
                    Test WhatsApp Configuration
                  </h3>

                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Test Phone Number *
                      </label>
                      <div className="flex gap-2">
                        <div className="flex items-center px-3 border border-gray-300 rounded-l-lg bg-gray-50">
                          <span className="text-gray-600">+91</span>
                        </div>
                        <input
                          type="tel"
                          value={testRecipient}
                          onChange={(e) => {
                            const value = e.target.value.replace(/\D/g, '').slice(0, 10);
                            setTestRecipient(value);
                          }}
                          placeholder="9876543210"
                          maxLength={10}
                          className={`flex-1 px-4 py-2 border rounded-r-lg focus:ring-2 focus:ring-green-500 focus:border-transparent ${
                            testRecipient && testRecipient.length === 10
                              ? 'border-green-300'
                              : testRecipient
                                ? 'border-yellow-300'
                                : 'border-gray-300'
                          }`}
                        />
                      </div>
                      {testRecipient && (
                        <p className={`text-xs mt-1 ${
                          testRecipient.length === 10
                            ? 'text-green-600'
                            : 'text-yellow-600'
                        }`}>
                          {testRecipient.length === 10
                            ? 'âœ“ Valid 10-digit number'
                            : `âš  Enter ${10 - testRecipient.length} more digit(s)`
                          }
                        </p>
                      )}
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Test Message
                      </label>
                      <textarea
                        value="This is a test WhatsApp message from BookBharat notification system."
                        readOnly
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600"
                        rows={3}
                      />
                    </div>

                    <button
                      onClick={handleWhatsAppTest}
                      disabled={testWhatsAppMutation.isPending || !whatsappConfig.api_url || !whatsappConfig.access_token || !whatsappConfig.phone_number_id || testRecipient.length !== 10}
                      className="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 font-medium"
                    >
                      {testWhatsAppMutation.isPending ? (
                        <>
                          <Loader2 className="h-4 w-4 animate-spin" />
                          Sending Test WhatsApp...
                        </>
                      ) : (
                        <>
                          <Send className="h-4 w-4" />
                          Send Test WhatsApp
                        </>
                      )}
                    </button>

                    {!whatsappConfig.api_url && (
                      <p className="text-xs text-red-600">âš  Please configure API URL first</p>
                    )}
                    {!whatsappConfig.access_token && (
                      <p className="text-xs text-red-600">âš  Please configure access token first</p>
                    )}
                    {!whatsappConfig.phone_number_id && (
                      <p className="text-xs text-red-600">âš  Please configure phone number ID first</p>
                    )}
                    {testRecipient && testRecipient.length !== 10 && (
                      <p className="text-xs text-yellow-600">âš  Please enter a valid 10-digit phone number</p>
                    )}
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-3">
                  <button
                    onClick={saveWhatsAppConfig}
                    disabled={updateMutation.isPending || !whatsappConfig.api_url || !whatsappConfig.access_token || !whatsappConfig.phone_number_id || !whatsappConfig.business_account_id}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  >
                    {updateMutation.isPending ? (
                      <>
                        <Loader2 className="h-4 w-4 animate-spin" />
                        Saving...
                      </>
                    ) : (
                      <>
                        <Check className="h-4 w-4" />
                        Save Configuration
                      </>
                    )}
                  </button>

                  <button
                    onClick={handleSyncTemplates}
                    disabled={syncTemplatesMutation.isPending || !whatsappConfig.access_token || !whatsappConfig.business_account_id}
                    className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  >
                    {syncTemplatesMutation.isPending ? (
                      <>
                        <Loader2 className="h-4 w-4 animate-spin" />
                        Syncing...
                      </>
                    ) : (
                      <>
                        <RefreshCw className="h-4 w-4" />
                        Sync Templates
                      </>
                    )}
                  </button>
                </div>
              </div>
            </div>
          </div>

          {/* Popular WhatsApp Providers */}
          <div className="bg-white rounded-lg shadow p-6">
            <h3 className="text-lg font-semibold mb-4">WhatsApp Business Setup Guide</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div className="border rounded-lg p-4 hover:shadow-md transition-shadow">
                <div className="font-semibold text-gray-900 mb-2">Meta Business Suite</div>
                <div className="text-gray-600 space-y-1">
                  <p>â€¢ Create WhatsApp Business Account</p>
                  <p>â€¢ Verify business documents</p>
                  <p>â€¢ Add phone number</p>
                  <p className="text-xs text-blue-600">Official Meta provider</p>
                </div>
              </div>

              <div className="border rounded-lg p-4 hover:shadow-md transition-shadow">
                <div className="font-semibold text-gray-900 mb-2">Third-party Providers</div>
                <div className="text-gray-600 space-y-1">
                  <p>â€¢ Twilio WhatsApp API</p>
                  <p>â€¢ MessageBird WhatsApp</p>
                  <p>â€¢ Gupshup WhatsApp</p>
                  <p className="text-xs text-blue-600">Easier integration options</p>
                </div>
              </div>
            </div>
          </div>

          {/* WhatsApp Templates */}
          {(() => {
            const firstSetting = settings[Object.keys(settings)[0]];
            const templates = firstSetting?.whatsapp_templates;

            if (!templates || !Array.isArray(templates) || templates.length === 0) {
              return (
                <div className="bg-white rounded-lg shadow p-6">
                  <h3 className="text-lg font-semibold mb-4">WhatsApp Templates</h3>
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div className="flex gap-3">
                      <AlertCircle className="h-5 w-5 text-yellow-600 flex-shrink-0 mt-0.5" />
                      <div className="text-sm text-yellow-800">
                        <p className="font-semibold">No templates found</p>
                        <p>Click "Sync Templates" after configuring your WhatsApp Business API to fetch your approved message templates.</p>
                      </div>
                    </div>
                  </div>
                </div>
              );
            }

            return (
              <div className="bg-white rounded-lg shadow p-6">
                <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                  <MessageSquare className="h-5 w-5 text-green-600" />
                  WhatsApp Templates ({templates.length})
                </h3>
                <div className="space-y-3">
                  {templates.map((template: any, index: number) => (
                    <div key={index} className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                      <div className="flex items-center justify-between">
                        <div className="flex-1">
                          <div className="font-medium text-gray-900 flex items-center gap-2">
                            {template.name}
                            <span className={`px-2 py-1 text-xs rounded-full ${
                              template.status === 'APPROVED'
                                ? 'bg-green-100 text-green-800'
                                : template.status === 'PENDING'
                                  ? 'bg-yellow-100 text-yellow-800'
                                  : 'bg-red-100 text-red-800'
                            }`}>
                              {template.status}
                            </span>
                          </div>
                          <div className="text-sm text-gray-600 mt-1">
                            {template.category && (
                              <span className="mr-3">Category: {template.category}</span>
                            )}
                            {template.language?.code && (
                              <span>Language: {template.language.code}</span>
                            )}
                          </div>
                        </div>
                        <div className="text-right">
                          <div className="text-xs text-gray-400">
                            {template.language?.name || template.language?.code || 'en'}
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            );
          })()}
        </div>
      )}

      {/* Email Configuration Tab */}
      {activeTab === 'email' && (
        <div className="space-y-6">
          <div className="bg-white rounded-lg shadow p-6">
            <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
              <Mail className="h-5 w-5 text-blue-600" />
              Email (SMTP) Configuration
            </h2>

            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
              <div className="flex gap-3">
                <AlertCircle className="h-5 w-5 text-blue-600 flex-shrink-0 mt-0.5" />
                <div className="text-sm text-blue-800">
                  <p className="font-semibold mb-1">SMTP Email Setup:</p>
                  <ul className="list-disc list-inside space-y-1">
                    <li>Configure your SMTP server details for transactional emails</li>
                    <li>Use app passwords for Gmail/Google Workspace</li>
                    <li>Test connection before saving configuration</li>
                    <li>Supported providers: Gmail, SendGrid, Mailgun, Amazon SES</li>
                  </ul>
                </div>
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Configuration Fields */}
              <div className="space-y-4">
                <div className="grid grid-cols-1 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      SMTP Host *
                    </label>
                    <input
                      type="text"
                      value={emailConfig.host}
                      onChange={(e) => setEmailConfig({ ...emailConfig, host: e.target.value })}
                      placeholder="smtp.gmail.com"
                      className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                        emailConfig.host ? 'border-gray-300' : 'border-red-300'
                      }`}
                    />
                    {emailConfig.host && (
                      <p className="text-xs text-green-600 mt-1">âœ“ SMTP host configured</p>
                    )}
                  </div>

                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        SMTP Port *
                      </label>
                      <input
                        type="number"
                        value={emailConfig.port}
                        onChange={(e) => setEmailConfig({ ...emailConfig, port: parseInt(e.target.value) || 587 })}
                        placeholder="587"
                        min={1}
                        max={65535}
                        className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                          emailConfig.port ? 'border-gray-300' : 'border-red-300'
                        }`}
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Encryption *
                      </label>
                      <select
                        value={emailConfig.encryption}
                        onChange={(e) => setEmailConfig({ ...emailConfig, encryption: e.target.value as any })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      >
                        <option value="tls">TLS</option>
                        <option value="ssl">SSL</option>
                      </select>
                    </div>
                  </div>
                </div>

                <div className="border-t pt-4 mt-4">
                  <h3 className="text-sm font-semibold text-gray-700 mb-3">Authentication</h3>

                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        SMTP Username *
                      </label>
                      <input
                        type="text"
                        value={emailConfig.username}
                        onChange={(e) => setEmailConfig({ ...emailConfig, username: e.target.value })}
                        placeholder="your-email@gmail.com"
                        className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                          emailConfig.username ? 'border-gray-300' : 'border-red-300'
                        }`}
                      />
                      {emailConfig.username && (
                        <p className="text-xs text-green-600 mt-1">âœ“ Username configured</p>
                      )}
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        SMTP Password *
                      </label>
                      <div className="relative">
                        <input
                          type="password"
                          value={emailConfig.password}
                          onChange={(e) => setEmailConfig({ ...emailConfig, password: e.target.value })}
                          placeholder="Enter password or app password"
                          className={`w-full px-4 py-2 pr-10 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                            emailConfig.password ? 'border-gray-300' : 'border-red-300'
                          }`}
                        />
                        {emailConfig.password && (
                          <CheckCircle className="absolute right-3 top-2.5 h-5 w-5 text-green-500" />
                        )}
                      </div>
                    </div>
                  </div>
                </div>

                <div className="border-t pt-4 mt-4">
                  <h3 className="text-sm font-semibold text-gray-700 mb-3">From Settings</h3>

                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        From Email Address *
                      </label>
                      <input
                        type="email"
                        value={emailConfig.from_address}
                        onChange={(e) => setEmailConfig({ ...emailConfig, from_address: e.target.value })}
                        placeholder="noreply@bookbharat.com"
                        className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                          emailConfig.from_address && isValidEmail(emailConfig.from_address)
                            ? 'border-gray-300'
                            : emailConfig.from_address
                              ? 'border-red-300'
                              : 'border-gray-300'
                        }`}
                      />
                      {emailConfig.from_address && isValidEmail(emailConfig.from_address) && (
                        <p className="text-xs text-green-600 mt-1">âœ“ Valid email address</p>
                      )}
                      {emailConfig.from_address && !isValidEmail(emailConfig.from_address) && (
                        <p className="text-xs text-red-600 mt-1">âš  Please enter a valid email address</p>
                      )}
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        From Name *
                      </label>
                      <input
                        type="text"
                        value={emailConfig.from_name}
                        onChange={(e) => setEmailConfig({ ...emailConfig, from_name: e.target.value })}
                        placeholder="BookBharat"
                        className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                          emailConfig.from_name ? 'border-gray-300' : 'border-red-300'
                        }`}
                      />
                      {emailConfig.from_name && (
                        <p className="text-xs text-green-600 mt-1">âœ“ From name configured</p>
                      )}
                    </div>
                  </div>
                </div>

                <div className="flex gap-3 mt-6">
                  <button
                    onClick={saveEmailConfig}
                    disabled={updateEmailMutation.isPending || !isEmailConfigValid()}
                    className="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 font-medium"
                  >
                    {updateEmailMutation.isPending ? (
                      <>
                        <Loader2 className="h-4 w-4 animate-spin" />
                        Saving...
                      </>
                    ) : (
                      <>
                        <Check className="h-4 w-4" />
                        Save Configuration
                      </>
                    )}
                  </button>
                </div>
              </div>

              {/* Test Configuration */}
              <div className="space-y-4">
                <div className="bg-gray-50 rounded-lg p-4">
                  <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                    <Send className="h-5 w-5 text-blue-600" />
                    Test Email Configuration
                  </h3>

                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Test Email Address *
                      </label>
                      <input
                        type="email"
                        value={testRecipient}
                        onChange={(e) => setTestRecipient(e.target.value)}
                        placeholder="test@example.com"
                        className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                          testRecipient && isValidEmail(testRecipient)
                            ? 'border-green-300'
                            : testRecipient
                              ? 'border-red-300'
                              : 'border-gray-300'
                        }`}
                      />
                      {testRecipient && isValidEmail(testRecipient) && (
                        <p className="text-xs text-green-600 mt-1">âœ“ Valid email address</p>
                      )}
                      {testRecipient && !isValidEmail(testRecipient) && (
                        <p className="text-xs text-red-600 mt-1">âš  Please enter a valid email address</p>
                      )}
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Test Email Subject
                      </label>
                      <input
                        type="text"
                        value="BookBharat - Test Email Configuration"
                        readOnly
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Test Email Content
                      </label>
                      <textarea
                        value="This is a test email from BookBharat notification system to verify your SMTP configuration is working correctly."
                        readOnly
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600"
                        rows={4}
                      />
                    </div>

                    <button
                      onClick={() => {
                        setTestChannel('email');
                        handleTestNotification();
                      }}
                      disabled={testNotificationMutation.isPending || !testRecipient || !isValidEmail(testRecipient) || !isEmailConfigValid()}
                      className="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 font-medium"
                    >
                      {testNotificationMutation.isPending ? (
                        <>
                          <Loader2 className="h-4 w-4 animate-spin" />
                          Sending Test Email...
                        </>
                      ) : (
                        <>
                          <Send className="h-4 w-4" />
                          Send Test Email
                        </>
                      )}
                    </button>

                    {!isEmailConfigValid() && (
                      <div className="text-xs text-red-600 space-y-1">
                        {!emailConfig.host && <p>âš  Please configure SMTP host</p>}
                        {!emailConfig.username && <p>âš  Please configure SMTP username</p>}
                        {!emailConfig.password && <p>âš  Please configure SMTP password</p>}
                        {!emailConfig.from_address && <p>âš  Please configure from email address</p>}
                        {!emailConfig.from_name && <p>âš  Please configure from name</p>}
                      </div>
                    )}
                  </div>
                </div>

                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <h4 className="text-sm font-semibold text-blue-800 mb-2">ðŸ“§ Email Test Information</h4>
                  <ul className="text-xs text-blue-700 space-y-1">
                    <li>â€¢ Check spam folder if you don't receive the test email</li>
                    <li>â€¢ Verify SPF/DKIM records for better deliverability</li>
                    <li>â€¢ Use app passwords for Gmail/Google Workspace</li>
                    <li>â€¢ Test different ports (587/TLS, 465/SSL) if connection fails</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          {/* Popular SMTP Providers */}
          <div className="bg-white rounded-lg shadow p-6">
            <h3 className="text-lg font-semibold mb-4">Popular Email Service Providers</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div className="border rounded-lg p-4 hover:shadow-md transition-shadow">
                <div className="font-semibold text-gray-900 mb-2 flex items-center gap-2">
                  Gmail/Google Workspace
                  <span className="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">Popular</span>
                </div>
                <div className="text-gray-600 space-y-1">
                  <p><strong>Host:</strong> smtp.gmail.com</p>
                  <p><strong>Port:</strong> 587 (TLS)</p>
                  <p><strong>Username:</strong> your-email@gmail.com</p>
                  <p><strong>Password:</strong> App Password (recommended)</p>
                  <p className="text-xs text-blue-600 mt-2">Enable 2FA and create App Password</p>
                </div>
              </div>

              <div className="border rounded-lg p-4 hover:shadow-md transition-shadow">
                <div className="font-semibold text-gray-900 mb-2">SendGrid</div>
                <div className="text-gray-600 space-y-1">
                  <p><strong>Host:</strong> smtp.sendgrid.net</p>
                  <p><strong>Port:</strong> 587 (TLS)</p>
                  <p><strong>Username:</strong> apikey</p>
                  <p><strong>Password:</strong> Your API key</p>
                  <p className="text-xs text-blue-600 mt-2">Create API key in SendGrid dashboard</p>
                </div>
              </div>

              <div className="border rounded-lg p-4 hover:shadow-md transition-shadow">
                <div className="font-semibold text-gray-900 mb-2">Mailgun</div>
                <div className="text-gray-600 space-y-1">
                  <p><strong>Host:</strong> smtp.mailgun.org</p>
                  <p><strong>Port:</strong> 587 (TLS)</p>
                  <p><strong>Username:</strong> postmaster@yourdomain.com</p>
                  <p><strong>Password:</strong> Your SMTP password</p>
                  <p className="text-xs text-blue-600 mt-2">Verify domain in Mailgun dashboard</p>
                </div>
              </div>

              <div className="border rounded-lg p-4 hover:shadow-md transition-shadow">
                <div className="font-semibold text-gray-900 mb-2">Amazon SES</div>
                <div className="text-gray-600 space-y-1">
                  <p><strong>Host:</strong> email-smtp.region.amazonaws.com</p>
                  <p><strong>Port:</strong> 587 (TLS)</p>
                  <p><strong>Username:</strong> Your SMTP credentials</p>
                  <p><strong>Password:</strong> Your SMTP password</p>
                  <p className="text-xs text-blue-600 mt-2">Create SMTP credentials in AWS SES</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default NotificationSettings;

